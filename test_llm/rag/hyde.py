"""
HyDE (Hypothetical Document Embeddings)
Генерация расширенного гипотетического документа для улучшения поиска
"""


class HyDEGenerator:
    """Генератор гипотетических документов для улучшения поиска"""
    
    def __init__(self, llm_client):
        """
        Args:
            llm_client: Клиент LLM (Ollama или Mock)
        """
        self.llm_client = llm_client
        self.is_mock = hasattr(llm_client, '__class__') and 'Mock' in llm_client.__class__.__name__
    
    def generate_hypothetical_answer(self, question: str) -> str:
        """
        Генерация РАСШИРЕННОГО гипотетического ответа на вопрос
        
        Идея HyDE:
        1. Создать фейковый документ который БЫ мог ответить на вопрос
        2. Этот документ включает синонимы, контекст, расширенные термины
        3. Поиск по такому документу находит более релевантные chunks
        
        Args:
            question: Вопрос пользователя
            
        Returns:
            Расширенный гипотетический документ
        """
        
        # Для Mock клиента - используем улучшенную генерацию
        if self.is_mock:
            return self._generate_enriched_mock_answer(question)
        
        # Для реального LLM - создаем промпт для расширенного ответа
        prompt = f"""Ты эксперт по банковским продуктам.

Твоя задача: создать РАСШИРЕННЫЙ гипотетический ответ на вопрос.

Ответ должен:
- Быть развернутым (3-5 предложений)
- Включать синонимы и связанные термины
- Содержать контекст и детали
- Использовать профессиональную банковскую терминологию

Вопрос: {question}

Расширенный гипотетический ответ:"""
        
        try:
            # Генерируем БЕЗ контекста (пустой список)
            hypothetical = self.llm_client.generate(prompt, [])
            hypothetical = hypothetical.strip()
            
            # Убрать префикс если модель его повторила
            if hypothetical.startswith("Расширенный гипотетический ответ:"):
                hypothetical = hypothetical.replace("Расширенный гипотетический ответ:", "").strip()
            
            return hypothetical
            
        except Exception as e:
            print(f"[WARNING] Ошибка генерации HyDE: {e}")
            return question
    
    def _generate_enriched_mock_answer(self, question: str) -> str:
        """
        Генерация ОБОГАЩЕННОГО mock ответа с синонимами и контекстом
        Создает фейковый документ который похож на реальные chunks
        """
        question_lower = question.lower()
        
        # Расширенные шаблоны с ДОПОЛНИТЕЛЬНЫМ контекстом и синонимами
        enriched_templates = {
            'карт': [
                """Основная карта (главная, первичная карта) выпускается на владельца счета - Клиента банка.
                Дополнительная карта (вторичная, добавочная карта) выпускается на представителя или члена семьи.
                Обе карты привязаны к одному счету и используют общий лимит средств.
                Различия касаются прав доступа, контроля операций и возможностей управления счетом.""",
                
                """Типы карт: Основная карта и Дополнительная карта различаются по владельцу.
                Основная - для владельца счета (держателя, клиента). 
                Дополнительная - для доверенного лица (представителя, родственника).
                Все транзакции по обеим картам отображаются в едином счете."""
            ],
            
            'дополнительн': [
                """Дополнительная карта (добавочная, вторичная карта) привязывается к счету основной карты.
                Эта карта используется представителем владельца счета или членом семьи.
                Лимит общий с основной картой, все операции контролируются владельцем основного счета.
                Может иметь ограничения по операциям согласно настройкам владельца.""",
                
                """Дополнительные (добавочные) карты позволяют членам семьи пользоваться одним счетом.
                Представитель получает доступ к средствам но не может изменять условия счета.
                Все транзакции по дополнительным картам видны владельцу основной карты."""
            ],
            
            'основн': [
                """Основная карта (главная, первичная карта) - это карта владельца банковского счета.
                Держатель основной карты имеет полный контроль над счетом, лимитами и операциями.
                К основной карте можно привязать дополнительные карты для других пользователей.
                Владелец основной карты несет ответственность за все операции по счету."""
            ],
            
            'лимит': [
                """Лимиты карт (ограничения, максимальные суммы) зависят от типа карты и тарифа.
                Общий лимит счета распределяется между основной и дополнительными картами.
                Владелец может устанавливать индивидуальные лимиты на снятие наличных, переводы и покупки.
                Превышение лимита приводит к блокировке операции.""",
                
                """Лимиты операций включают: суммы снятия наличных, переводов, покупок в интернете.
                Ограничения устанавливаются для безопасности и контроля расходов.
                Владелец основной карты может менять лимиты через интернет-банк."""
            ],
            
            'снять': [
                """Снятие наличных (обналичивание, получение денег) возможно в банкоматах и кассах банка.
                Применяются комиссии за снятие в сторонних банкоматах и лимиты на сумму.
                В банкоматах партнеров и собственных банкоматах обналичивание может быть бесплатным.
                Суточные и месячные лимиты на снятие наличных зависят от типа карты."""
            ],
            
            'цифров': [
                """Цифровая карта (виртуальная, электронная карта) - это карта без физического носителя.
                Используется для онлайн-покупок, бесконтактных платежей через смартфон.
                Может быть привязана только к определенному лицу согласно требованиям безопасности.
                Не имеет пластика но обладает всеми функциями обычной карты."""
            ],
            
            'мог': [
                """Возможности карты (права, доступные операции) зависят от типа карты и прав пользователя.
                Основная карта дает полный доступ ко всем функциям счета.
                Дополнительная карта может иметь ограничения установленные владельцем основного счета.
                Список доступных операций настраивается в интернет-банке."""
            ]
        }
        
        # Поиск подходящего обогащенного шаблона
        for keyword, answers in enriched_templates.items():
            if keyword in question_lower:
                import random
                return random.choice(answers).strip()
        
        # Универсальный РАСШИРЕННЫЙ ответ
        generic_enriched = [
            """Данная информация (сведения, данные) содержится в условиях договора банковского обслуживания.
            Правила и требования регулируются внутренними положениями банка и законодательством.
            Для получения точной информации рекомендуется обратиться в отделение банка или на горячую линию.""",
            
            """Условия предоставления услуги (требования, правила) зависят от типа продукта и тарифного плана.
            Каждый банковский продукт имеет свои особенности согласно тарифам и условиям обслуживания.
            Детальная информация доступна в договоре и на официальном сайте банка.""",
            
            """Подробную информацию (детали, сведения) можно получить несколькими способами:
            через интернет-банк, мобильное приложение, в отделении банка или по телефону горячей линии.
            Консультанты банка предоставят актуальную информацию по всем вопросам."""
        ]
        
        import random
        return random.choice(generic_enriched).strip()